name: Search Viral Prompts

on:
  schedule:
    # 每小时运行一次
    - cron: "0 * * * *"
  workflow_dispatch: # 允许手动触发
    inputs:
      min_likes:
        description: "最低点赞数"
        required: false
        type: number
        default: 30
      keywords:
        description: "搜索关键词 (逗号分隔)"
        required: false
        type: string
        default: ""
      hours:
        description: "只处理最近N小时的推文 (0=不限制)"
        required: false
        type: number
        default: 3
      dry_run:
        description: "预览模式（不写入数据库）"
        required: false
        type: boolean
        default: false

jobs:
  search:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: "worker/requirements.txt"

      - name: Install dependencies
        run: |
          cd worker
          pip install -r requirements.txt

      - name: Create cookies file
        env:
          X_COOKIES: ${{ secrets.X_COOKIES }}
        run: |
          echo "$X_COOKIES" > worker/x_cookies.json

      - name: Run search (scheduled)
        if: github.event_name == 'schedule'
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          GITEE_AI_API_KEY: ${{ secrets.GITEE_AI_API_KEY }}
        run: |
          cd worker
          python search_viral_prompts.py --min-likes 30 --hours 3 --count 30

      - name: Run search (manual)
        if: github.event_name == 'workflow_dispatch'
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          GITEE_AI_API_KEY: ${{ secrets.GITEE_AI_API_KEY }}
        run: |
          cd worker
          KEYWORDS_ARG=""
          if [ -n "${{ inputs.keywords }}" ]; then
            KEYWORDS_ARG="--keywords '${{ inputs.keywords }}'"
          fi

          python search_viral_prompts.py \
            --min-likes ${{ inputs.min_likes }} \
            --hours ${{ inputs.hours }} \
            $KEYWORDS_ARG \
            ${{ inputs.dry_run && '--dry-run' || '' }}

      - name: Show search summary
        if: always()
        run: |
          echo "## Viral Prompt Search Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Time**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

          if [ -f worker/x_search_state.json ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### State" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat worker/x_search_state.json | head -20 >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
