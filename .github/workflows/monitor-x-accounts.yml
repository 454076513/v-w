name: Monitor X Accounts

on:
  schedule:
    # 每 12 小时运行一次 (00:00 和 12:00 UTC)
    - cron: "0 */12 * * *"
  workflow_dispatch: # 允许手动触发
    inputs:
      top:
        description: "监听 Top N 作者（默认 30）"
        required: false
        type: number
        default: 30
      count:
        description: "每个账号获取推文数（默认 10）"
        required: false
        type: number
        default: 10
      viral_only:
        description: "仅处理爆款推文"
        required: false
        type: boolean
        default: false
      dry_run:
        description: "预览模式（不写入数据库）"
        required: false
        type: boolean
        default: false

jobs:
  monitor:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: "worker/requirements.txt"

      - name: Cache monitor state
        uses: actions/cache@v4
        with:
          path: |
            worker/x_monitor_state.json
          key: x-monitor-state-${{ github.run_id }}
          restore-keys: |
            x-monitor-state-

      - name: Ensure directories exist
        run: |
          mkdir -p worker/cache

      - name: Install dependencies
        run: |
          cd worker
          pip install -r requirements.txt

      - name: Run X Monitor (scheduled)
        if: github.event_name == 'schedule'
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NVIDIA_API_KEY: ${{ secrets.NVIDIA_API_KEY }}
          GITEE_AI_API_KEY: ${{ secrets.GITEE_AI_API_KEY }}
          X_COOKIE: ${{ secrets.X_COOKIE }}
        run: |
          cd worker
          python fetch_x_accounts.py --top 30 --count 10

      - name: Run X Monitor (manual)
        if: github.event_name == 'workflow_dispatch'
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NVIDIA_API_KEY: ${{ secrets.NVIDIA_API_KEY }}
          GITEE_AI_API_KEY: ${{ secrets.GITEE_AI_API_KEY }}
          X_COOKIE: ${{ secrets.X_COOKIE }}
        run: |
          cd worker
          python fetch_x_accounts.py \
            --top ${{ inputs.top }} \
            --count ${{ inputs.count }} \
            ${{ inputs.viral_only && '--viral-only' || '' }} \
            ${{ inputs.dry_run && '--dry-run' || '' }}

      - name: Show monitor summary
        if: always()
        run: |
          echo "## X Monitor Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Time**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f worker/x_monitor_state.json ]; then
            echo "### State File" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            head -20 worker/x_monitor_state.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY

            PROCESSED=$(cat worker/x_monitor_state.json | grep -o '"processed_tweets"' | wc -l || echo "0")
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Processed tweets in state file." >> $GITHUB_STEP_SUMMARY
          fi
