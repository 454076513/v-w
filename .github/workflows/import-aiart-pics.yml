name: Import AIART.PICS to Database

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ 02:00 è¿è¡Œï¼ˆUTC 18:00ï¼‰
    - cron: "0 18 * * *"
  workflow_dispatch:
    inputs:
      pages:
        description: "çˆ¬å–é¡µæ•° (é»˜è®¤: 2)"
        required: false
        type: number
        default: 2
      limit:
        description: "å¯¼å…¥æ•°é‡é™åˆ¶ (0 = æ— é™åˆ¶)"
        required: false
        type: number
        default: 0
      dry_run:
        description: "é¢„è§ˆæ¨¡å¼ (ä¸å†™å…¥æ•°æ®åº“)"
        required: false
        type: boolean
        default: false
      min_likes:
        description: "æœ€ä½Žç‚¹èµžæ•°è¿‡æ»¤ (é»˜è®¤: 30)"
        required: false
        type: number
        default: 30
      reset:
        description: "é‡ç½®è¿›åº¦ä»Žå¤´å¼€å§‹"
        required: false
        type: boolean
        default: false

env:
  PYTHON_VERSION: "3.11"

jobs:
  import-to-db:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"
          cache-dependency-path: "worker/requirements.txt"

      - name: Install dependencies
        run: |
          cd worker
          pip install -r requirements.txt

      - name: Install Playwright
        run: |
          pip install playwright
          playwright install chromium

      - name: Ensure cache directory exists
        run: mkdir -p worker/cache

      - name: Restore progress cache
        uses: actions/cache@v4
        with:
          path: worker/cache/aiart_pics_import_progress.json
          key: aiart-pics-import-progress
          restore-keys: |
            aiart-pics-import-progress

      - name: Show progress
        run: |
          if [ -f worker/cache/aiart_pics_import_progress.json ]; then
            PROCESSED=$(python3 -c "import json; print(len(json.load(open('worker/cache/aiart_pics_import_progress.json')).get('processed_slugs', [])))" 2>/dev/null || echo "0")
            echo "ðŸ“Š å·²å¤„ç†: $PROCESSED æ¡"
          else
            echo "ðŸ“Š è¿›åº¦æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°†ä»Žå¤´å¼€å§‹"
          fi

      - name: Run import
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          cd worker

          # æž„å»ºå‚æ•°
          ARGS=""

          # é¡µæ•°å‚æ•°
          PAGES="${{ inputs.pages }}"
          if [ -z "$PAGES" ]; then
            PAGES="2"
          fi
          ARGS="$ARGS --pages $PAGES"

          if [ "${{ inputs.limit }}" != "0" ] && [ -n "${{ inputs.limit }}" ]; then
            ARGS="$ARGS --limit ${{ inputs.limit }}"
          fi

          if [ "${{ inputs.dry_run }}" == "true" ]; then
            ARGS="$ARGS --dry-run"
          fi

          # æœ€ä½Žç‚¹èµžæ•°è¿‡æ»¤ (é»˜è®¤ 30)
          MIN_LIKES="${{ inputs.min_likes }}"
          if [ -z "$MIN_LIKES" ]; then
            MIN_LIKES="30"
          fi
          ARGS="$ARGS --min-likes $MIN_LIKES"

          if [ "${{ inputs.reset }}" == "true" ]; then
            ARGS="$ARGS --reset"
          fi

          echo "ðŸš€ è¿è¡Œ: python import_aiart_pics.py $ARGS"
          python import_aiart_pics.py $ARGS

      - name: Save progress cache
        uses: actions/cache/save@v4
        if: always()
        with:
          path: worker/cache/aiart_pics_import_progress.json
          key: aiart-pics-import-progress

      - name: Upload failed items
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: import-failed-${{ github.run_id }}
          path: worker/failed_imports/
          if-no-files-found: ignore
          retention-days: 30

      - name: Show summary
        if: always()
        run: |
          echo "## AIART.PICS Import Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f worker/cache/aiart_pics_import_progress.json ]; then
            PROCESSED=$(python3 -c "import json; print(len(json.load(open('worker/cache/aiart_pics_import_progress.json')).get('processed_slugs', [])))" 2>/dev/null || echo "0")
            LAST_UPDATE=$(python3 -c "import json; print(json.load(open('worker/cache/aiart_pics_import_progress.json')).get('last_updated', 'N/A'))" 2>/dev/null || echo "N/A")
            echo "### Progress" >> $GITHUB_STEP_SUMMARY
            echo "- Processed: **$PROCESSED** slugs" >> $GITHUB_STEP_SUMMARY
            echo "- Last updated: $LAST_UPDATE" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Parameters" >> $GITHUB_STEP_SUMMARY
          echo "- Pages: ${{ inputs.pages || '2' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Limit: ${{ inputs.limit || 'unlimited' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Min likes: ${{ inputs.min_likes || '30' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Dry run: ${{ inputs.dry_run }}" >> $GITHUB_STEP_SUMMARY
          echo "- Reset: ${{ inputs.reset }}" >> $GITHUB_STEP_SUMMARY
